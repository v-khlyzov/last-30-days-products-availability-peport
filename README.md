# Отчет о доступности товаров интернет-магазина за 30 дней
**Суть задачи:** Выгрузка формируется на уровне SKU с характеристиками, данными о товарообороте, цене, доступности и иными расчетными метриками + расчитывается прогноз потенциальных потерь в продажах на будущее из-за перебоев с наличием.

**Метод:** Отчет формируется на основании 4 выгрузок в csv, которые с помощью PowerQuery объединяются в единую таблицу, где в расчетных столбцах уже прописаны необходимые формулы.

**NB!** Помимо стандартных средств SQL, для выгрузки используется python (через Jupyter Notebook) из-за длины массива более 1 млн. строк. Чтобы избежать лишней нагрузки, реализовано порционирование (параметр задается в batch_size), а раздельные выгрузки этим же скриптом объединяются в единый csv.

## Этап 1 - Экспорт данных о ежедневной доступности товаров
Определяем товары, которые были на сайте как минимум 1 день за последние 30 дней. Содержит уникальный ключ «селлер-артикул» и 30 столбцов с бинарными значениями: наличие = 1, отсутствие = 0.
Выгружается из **ClickHouse** через ноутбук [экспорт доступности товаров (ClickHouse)](https://github.com/v-khlyzov/last-30-days-products-availability-peport/blob/831873dc3d2c49324fdca185920877087c0bbf4b/jupiter-notebooks/%D1%8D%D0%BA%D1%81%D0%BF%D0%BE%D1%80%D1%82%20%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D0%B8%20%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%BE%D0%B2%20(ClickHouse).ipynb)

## Этап 2 - Экспорт мастер-данных по товарам
Данная выгрузка содержит необходимые характеристики товаров (его продавца, наименование, товарную категорию и так далее)
Выгружается из **GreenPlum** через ноутбук [порционный экспорт мастер-данных по товарам (GreenPlum).ipynb](https://github.com/v-khlyzov/last-30-days-products-availability-peport/blob/e0a0ad8ec92a25c54b66cd23107c73a4580f2f13/jupiter-notebooks/%D0%BF%D0%BE%D1%80%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B9%20%D1%8D%D0%BA%D1%81%D0%BF%D0%BE%D1%80%D1%82%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D0%BF%D0%BE%20%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%B0%D0%BC%20(GreenPlum).ipynb)

## Этап 3 - Экспорт продаж по товарам и селлерам
Скрипт сразу рассчитывает ABC-сегментацию товаров и селлеров, согласно их вкладу в общий GMV за 30 дней по долям 50% / 30% / 20%.
Выгружается из PostgreSQL без партиционирования скриптом [выгрузка продаж за 30 дней с ABC сегментацией.sql](https://github.com/v-khlyzov/last-30-days-products-availability-peport/blob/e0a0ad8ec92a25c54b66cd23107c73a4580f2f13/sql-scripts/%D0%B2%D1%8B%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B6%20%D0%B7%D0%B0%2030%20%D0%B4%D0%BD%D0%B5%D0%B9%20%D1%81%20ABC%20%D1%81%D0%B5%D0%B3%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D0%B5%D0%B9.sql)

## Этап 4 - Выгрузка просмотров карточек товаров
Для полноты картины также учитываются веб-метрики по товарам, в данном случае берутся только просмотры карточки.
Выгружается из ClickHouse без партиционирования скриптом [просмотры карточек товаров за 30 дней.sql](https://github.com/v-khlyzov/last-30-days-products-availability-peport/blob/e0a0ad8ec92a25c54b66cd23107c73a4580f2f13/sql-scripts/%D0%BF%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80%D1%8B%20%D0%BA%D0%B0%D1%80%D1%82%D0%BE%D1%87%D0%B5%D0%BA%20%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%BE%D0%B2%20%D0%B7%D0%B0%2030%20%D0%B4%D0%BD%D0%B5%D0%B9.sql)

## Этап 5 - Объединение данных в PowerQuery
Итак, у нас есть 4 csv с файла из разных источников. Базовый файл - выгрузка товаров, доступных за 30 дней, так как именно он определяет длину массива. Во всех случаях тип объединения будет стоять по умолчанию как "Внешнее соединение слева", аналог left join.

К базомому файлу через функцию "Объединить" приобщаем:
1. оплаты по товарам за 30 дней по ключу product_key, Пустые значения "NULL" в атрибутах gmv_last_30_days и qty_last_30_days мы меняем на 0, а в ABC_goods и ABC_sellers - на латинскую букву C, т.к. товары без продаж автоматически при ABC сегментации относятся к сегменту C;
2. весь ассортимент, предварительно через шаг "Источник" в PowerQuery для него указываем "Пропустить разрывы строк". В качестве общего ключа также используем product_key в обоих таблицах;
3. просмотры присоединяем по столбцу с product_id, так как система веб-аналитики сохраняет только артикул товара без привязки к селлеру.

После всех манипуляций важно **удалить дубликаты** по полю product_key и добавить сортировку по атрибуту gmv_last_30_days, чтобы вверху таблицы были товары с наибольшими продажами.

Производим выгрузку на лист в Excel через функцию "Закрыть и загрузить в", после выхода в Excel нажимаем кнопку отмены и после нажатием правой кнопки в меню справа выгружаем на лист только нашу главную таблицу.

В итоге, получается сводная таблица со всеми необходимым данными для принятия решений по товару.
![Доступность товаров за 30 дней](https://github.com/v-khlyzov/last-30-days-products-availability-peport/blob/aa112219a796d8b7338c0c7635c8a56459642b06/images/%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D1%8C%20%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%BE%D0%B2%20%D0%B7%D0%B0%2030%20%D0%B4%D0%BD%D0%B5%D0%B9.png)
[Доступность товаров за 30 дней](https://1drv.ms/x/c/312bded3bb6cfc05/EQvgyD9VB1FCjwuqH7ztWw4BmgDnL92vFLkcpj8dAiOiyQ?e=u36LJf)

## Вывод
Отчет позволяет комплесно посмотреть на эффективность SKU или целой категории, а также подсветить зоны роста для селлера, основываясь на исторических данных.
